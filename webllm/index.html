<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Local Web LLM â€” Agent Interface</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Geist+Mono:wght@300;400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --black: #000000;
      --deep: #020202;
      --charcoal: #303030;
      --char2: #323131;
      --mid: #545352;
      --light: #737270;
      --bg: #eeeeee;
      --bg2: #f6f6f6;
      --orange: #ea6626;
      --soft: #e8ab8f;
      --white: #ffffff;

      --sp1: 10px;
      --sp2: 20px;
      --sp3: 32px;
      --sp4: 48px;
      --font: 'Geist Mono', monospace;
      --mono: 'Geist Mono', monospace;
      --dur: 200ms;
      --ease: cubic-bezier(0.25, 0, 0, 1);
    }

    html,
    body {
      height: 100%;
      overflow: hidden;
    }

    body {
      background: var(--bg);
      color: var(--charcoal);
      font-family: var(--font);
      font-weight: 400;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      display: flex;
      flex-direction: column;
    }

    /* TOPBAR */
    .topbar {
      height: 64px;
      flex-shrink: 0;
      background: var(--deep);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 var(--sp4);
      border-bottom: 1px solid #181818;
      z-index: 50;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand-mark {
      width: 24px;
      height: 24px;
      border: 1.5px solid var(--orange);
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2px;
      padding: 3px;
    }

    .brand-mark span {
      background: var(--orange);
      display: block;
    }

    .brand-mark span:nth-child(2) {
      background: transparent;
      border: 1px solid var(--orange);
    }

    .brand-name {
      font-family: var(--mono);
      font-size: 13px;
      color: var(--bg);
      letter-spacing: 0.1em;
      text-transform: uppercase;
    }

    .topbar-center {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--light);
      transition: background var(--dur);
    }

    .status-dot.active {
      background: var(--orange);
      animation: pulse 2.5s ease-in-out infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1
      }

      50% {
        opacity: .3
      }
    }

    .status-text {
      font-family: var(--mono);
      font-size: 12px;
      color: var(--light);
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: var(--sp3);
    }

    .live-badge {
      font-family: var(--mono);
      font-size: 12px;
      color: var(--light);
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .live-badge span {
      color: var(--soft);
    }

    /* SHELL */
    .shell {
      flex: 1;
      min-height: 0;
      display: grid;
      grid-template-columns: 320px 1fr 260px;
      overflow: hidden;
    }

    /* PANEL LEFT */
    .panel-left {
      background: var(--bg2);
      border-right: 1px solid #d8d8d8;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .panel-section {
      padding: var(--sp3);
      border-bottom: 1px solid #e0e0e0;
    }

    .section-label {
      font-family: var(--mono);
      font-size: 12px;
      color: var(--light);
      letter-spacing: 0.1em;
      text-transform: uppercase;
      margin-bottom: var(--sp2);
    }

    .model-select {
      width: 100%;
      background: var(--white);
      border: 1px solid #d4d4d4;
      padding: 8px 28px 8px 10px;
      font-family: var(--mono);
      font-size: 13px;
      color: var(--charcoal);
      outline: none;
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' viewBox='0 0 10 6'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%23737270' stroke-width='1.5' fill='none'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      margin-bottom: var(--sp2);
    }

    .model-select:focus {
      border-color: var(--charcoal);
    }

    .load-btn {
      width: 100%;
      background: var(--charcoal);
      color: var(--bg);
      border: none;
      padding: 10px;
      font-family: var(--mono);
      font-size: 13px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: background var(--dur) var(--ease);
    }

    .load-btn:hover {
      background: var(--black);
    }

    .load-btn:disabled {
      background: var(--mid);
      cursor: not-allowed;
    }

    .progress-wrap {
      margin-top: var(--sp2);
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .progress-wrap.hidden {
      display: none;
    }

    .progress-track {
      height: 2px;
      background: #d8d8d8;
    }

    .progress-fill {
      height: 100%;
      background: var(--orange);
      width: 0%;
      transition: width 250ms var(--ease);
    }

    .progress-meta {
      display: flex;
      justify-content: space-between;
    }

    .progress-label {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--light);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 140px;
    }

    .progress-pct {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--orange);
      flex-shrink: 0;
    }

    .sys-prompt {
      width: 100%;
      background: var(--white);
      border: 1px solid #d4d4d4;
      padding: 8px 10px;
      font-family: var(--mono);
      font-size: 13px;
      color: var(--charcoal);
      resize: none;
      outline: none;
      line-height: 1.55;
      min-height: 72px;
      transition: border-color var(--dur);
    }

    .sys-prompt:focus {
      border-color: var(--charcoal);
    }

    .slider-row {
      display: flex;
      flex-direction: column;
      gap: 5px;
      margin-bottom: var(--sp2);
    }

    .slider-row:last-child {
      margin-bottom: 0;
    }

    .slider-label {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
    }

    .slider-name {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--light);
      letter-spacing: 0.07em;
      text-transform: uppercase;
    }

    .slider-val {
      font-family: var(--mono);
      font-size: 13px;
      color: var(--char2);
      font-weight: 500;
    }

    input[type=range] {
      -webkit-appearance: none;
      width: 100%;
      height: 2px;
      background: linear-gradient(to right, var(--charcoal) var(--fill, 0%), #d8d8d8 var(--fill, 0%));
      outline: none;
      cursor: pointer;
    }

    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 10px;
      height: 10px;
      background: var(--orange);
      cursor: pointer;
      border-radius: 0;
    }

    .spec-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      padding: 5px 0;
      border-bottom: 1px solid #ebebeb;
    }

    .spec-row:last-child {
      border-bottom: none;
    }

    .spec-key {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--light);
      letter-spacing: 0.05em;
    }

    .spec-val {
      font-family: var(--mono);
      font-size: 13px;
      color: var(--char2);
    }

    .spec-val.hl {
      color: var(--orange);
    }

    .clear-btn {
      width: 100%;
      background: transparent;
      border: 1px solid #d4d4d4;
      color: var(--mid);
      padding: 8px;
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      cursor: pointer;
      transition: border-color var(--dur), color var(--dur);
    }

    .clear-btn:hover {
      border-color: var(--charcoal);
      color: var(--charcoal);
    }

    /* PANEL CENTER */
    .panel-center {
      display: flex;
      flex-direction: column;
      background: var(--bg);
      border-right: 1px solid #d8d8d8;
      min-height: 0;
    }

    .chat-header {
      height: 60px;
      flex-shrink: 0;
      border-bottom: 1px solid #d8d8d8;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 var(--sp3);
    }

    .chat-header-title {
      font-size: 15px;
      font-weight: 500;
      color: var(--charcoal);
      letter-spacing: -0.01em;
    }

    .chat-header-meta {
      font-family: var(--mono);
      font-size: 12px;
      color: var(--light);
      letter-spacing: 0.05em;
    }

    /* Init overlay */
    .init-overlay {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: var(--sp3);
      padding: var(--sp4);
    }

    .init-overlay.hidden {
      display: none;
    }

    .init-glyph {
      display: grid;
      grid-template-columns: repeat(4, 16px);
      gap: 3px;
      margin-bottom: var(--sp2);
    }

    .init-cell {
      width: 16px;
      height: 16px;
      background: #e0e0e0;
    }

    .init-cell:nth-child(3n) {
      background: var(--charcoal);
    }

    .init-cell:nth-child(7) {
      background: var(--orange);
      animation: cell-pulse 1.8s ease-in-out infinite;
    }

    @keyframes cell-pulse {

      0%,
      100% {
        opacity: 1
      }

      50% {
        opacity: .3
      }
    }

    .init-title {
      font-size: 28px;
      font-weight: 500;
      color: var(--charcoal);
      letter-spacing: -0.02em;
      text-align: center;
      line-height: 1.2;
    }

    .init-sub {
      font-family: var(--mono);
      font-size: 13px;
      color: var(--light);
      text-align: center;
      line-height: 1.7;
      letter-spacing: 0.02em;
    }

    /* Messages */
    .messages {
      flex: 1;
      overflow-y: auto;
      min-height: 0;
      padding: var(--sp3) var(--sp4);
      display: flex;
      flex-direction: column;
      gap: var(--sp3);
    }

    .messages.hidden {
      display: none;
    }

    .messages::-webkit-scrollbar {
      width: 3px;
    }

    .messages::-webkit-scrollbar-thumb {
      background: #ccc;
    }

    .message {
      display: flex;
      gap: var(--sp2);
      animation: msg-in 180ms var(--ease);
    }

    @keyframes msg-in {
      from {
        opacity: 0;
        transform: translateY(4px)
      }

      to {
        opacity: 1;
        transform: none
      }
    }

    .message.user {
      flex-direction: row-reverse;
    }

    .msg-avatar {
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: 0.05em;
      color: var(--light);
      padding-top: 20px;
      flex-shrink: 0;
      width: 36px;
      text-align: center;
    }

    .message.user .msg-avatar {
      color: var(--orange);
    }

    .msg-body {
      display: flex;
      flex-direction: column;
      gap: 3px;
      max-width: 78%;
    }

    .message.user .msg-body {
      align-items: flex-end;
    }

    .msg-header {
      display: flex;
      gap: 10px;
      align-items: baseline;
    }

    .message.user .msg-header {
      flex-direction: row-reverse;
    }

    .msg-name {
      font-family: var(--mono);
      font-size: 12px;
      color: var(--light);
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .message.user .msg-name {
      color: var(--orange);
    }

    .msg-time {
      font-family: var(--mono);
      font-size: 11px;
      color: #bbb;
      letter-spacing: 0.03em;
    }

    .msg-content {
      font-size: 16px;
      line-height: 1.65;
      color: var(--char2);
      word-break: break-word;
    }

    .msg-content p,
    .msg-content ol,
    .msg-content ul {
      margin-top: 0;
      margin-bottom: 0.75em;
    }

    .msg-content p:last-child,
    .msg-content ol:last-child,
    .msg-content ul:last-child {
      margin-bottom: 0;
    }

    .msg-content pre {
      background: var(--bg2);
      border: 1px solid #e0e0e0;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      font-family: var(--mono);
      font-size: 15px;
      margin-bottom: 0.75em;
    }

    .msg-content code {
      font-family: var(--mono);
      background: var(--bg2);
      padding: 2px 4px;
      border-radius: 3px;
      font-size: 15px;
    }

    .msg-content pre code {
      background: none;
      padding: 0;
    }

    .msg-content ul,
    .msg-content ol {
      padding-left: 1.5em;
    }

    .msg-content blockquote {
      border-left: 3px solid var(--orange);
      padding-left: 10px;
      color: var(--soft);
      margin-bottom: 0.75em;
    }

    .message.user .msg-content {
      background: var(--white);
      border: 1px solid #e0e0e0;
      padding: 10px 14px;
      color: var(--charcoal);
      white-space: pre-wrap;
    }

    .typing-cursor {
      display: inline-block;
      width: 2px;
      height: 14px;
      background: var(--orange);
      margin-left: 2px;
      vertical-align: middle;
      animation: blink 1s step-end infinite;
    }

    @keyframes blink {

      0%,
      100% {
        opacity: 1
      }

      50% {
        opacity: 0
      }
    }

    /* Token bar */
    .token-bar {
      height: 34px;
      flex-shrink: 0;
      border-top: 1px solid #d8d8d8;
      background: var(--bg2);
      display: flex;
      align-items: center;
      padding: 0 var(--sp3);
      gap: var(--sp3);
    }

    .token-bar.hidden {
      display: none;
    }

    .tbar-item {
      display: flex;
      align-items: baseline;
      gap: 5px;
    }

    .tbar-key {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--light);
      letter-spacing: 0.07em;
      text-transform: uppercase;
    }

    .tbar-val {
      font-family: var(--mono);
      font-size: 13px;
      color: var(--char2);
      font-weight: 500;
    }

    .tbar-val.active {
      color: var(--orange);
    }

    .tbar-sep {
      width: 1px;
      height: 14px;
      background: #d4d4d4;
    }

    /* Input */
    .input-area {
      border-top: 1px solid #d8d8d8;
      background: var(--bg2);
      padding: var(--sp2) var(--sp3);
      flex-shrink: 0;
    }

    .input-area.hidden {
      display: none;
    }

    .input-row {
      display: flex;
      gap: var(--sp2);
      align-items: flex-end;
    }

    .user-input {
      flex: 1;
      background: var(--white);
      border: 1px solid #d4d4d4;
      padding: 10px var(--sp2);
      font-family: var(--font);
      font-size: 16px;
      color: var(--charcoal);
      resize: none;
      outline: none;
      line-height: 1.5;
      min-height: 54px;
      max-height: 180px;
      overflow-y: auto;
      transition: border-color var(--dur);
    }

    .user-input::placeholder {
      color: #aaa;
    }

    .user-input:focus {
      border-color: var(--charcoal);
    }

    .send-btn {
      background: var(--charcoal);
      color: var(--bg);
      border: none;
      height: 54px;
      padding: 0 18px;
      font-family: var(--mono);
      font-size: 12px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background var(--dur) var(--ease);
      white-space: nowrap;
      flex-shrink: 0;
    }

    .send-btn:hover {
      background: var(--black);
    }

    .send-btn:disabled {
      background: var(--mid);
      cursor: not-allowed;
    }

    .input-hint {
      margin-top: 5px;
      font-family: var(--mono);
      font-size: 11px;
      color: var(--light);
      letter-spacing: 0.04em;
    }

    /* PANEL RIGHT */
    .panel-right {
      background: var(--bg2);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .metric-block {
      padding: var(--sp3);
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      flex-direction: column;
      gap: var(--sp2);
    }

    .metric-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .metric-label {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
    }

    .metric-name {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--light);
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .metric-value {
      font-family: var(--mono);
      font-size: 14px;
      color: var(--char2);
      font-weight: 500;
    }

    .metric-value.active {
      color: var(--orange);
    }

    .bar-track {
      height: 2px;
      background: #d8d8d8;
    }

    .bar-fill {
      height: 100%;
      background: var(--light);
      transition: width 500ms var(--ease);
    }

    .bar-fill.hl {
      background: var(--orange);
    }

    .log-wrap {
      padding: 0 var(--sp3) var(--sp3);
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .log-stream {
      flex: 1;
      overflow-y: auto;
      background: var(--white);
      border: 1px solid #e4e4e4;
      padding: 8px;
      min-height: 100px;
      max-height: 220px;
      display: flex;
      flex-direction: column;
      gap: 1px;
    }

    .log-stream::-webkit-scrollbar {
      width: 2px;
    }

    .log-stream::-webkit-scrollbar-thumb {
      background: #ccc;
    }

    .log-entry {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--light);
      line-height: 1.7;
      letter-spacing: 0.02em;
      animation: log-in 150ms var(--ease);
    }

    @keyframes log-in {
      from {
        opacity: 0;
        transform: translateX(-3px)
      }

      to {
        opacity: 1;
        transform: none
      }
    }

    .log-entry .ts {
      color: #c0c0c0;
      margin-right: 5px;
    }

    .log-entry.ok {
      color: #7a9e7e;
    }

    .log-entry.warn {
      color: var(--soft);
    }

    .log-entry.hl {
      color: var(--orange);
    }

    /* FOOTER */
    .footer {
      height: 48px;
      flex-shrink: 0;
      background: var(--deep);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 var(--sp4);
      border-top: 1px solid #111;
    }

    .footer-headline {
      font-size: 15px;
      font-weight: 500;
      color: var(--bg);
      letter-spacing: -0.01em;
      line-height: 1.15;
    }

    .footer-headline em {
      font-style: normal;
      color: var(--orange);
    }

    .footer-viz {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .footer-viz-label {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--light);
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .viz-bars {
      display: flex;
      gap: 2px;
      align-items: flex-end;
      height: 24px;
    }

    .viz-bar {
      width: 3px;
      background: var(--charcoal);
      min-height: 2px;
      transition: height 350ms var(--ease), background 350ms;
    }

    .viz-bar.hl {
      background: var(--orange);
    }

    ::-webkit-scrollbar {
      width: 3px;
      height: 3px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: #ccc;
    }

    /* Modal styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.hidden {
      display: none;
    }

    .modal {
      background: var(--bg2);
      border: 1px solid #d4d4d4;
      width: 800px;
      max-width: 95%;
      display: flex;
      flex-direction: column;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .modal-header {
      padding: var(--sp3);
      border-bottom: 1px solid #d4d4d4;
      background: var(--white);
    }

    .modal-title {
      font-size: 15px;
      font-weight: 500;
      color: var(--charcoal);
    }

    .modal-body {
      padding: var(--sp3);
      display: flex;
      flex-direction: column;
    }

    .input-lbl {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--light);
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    .modal-footer {
      padding: var(--sp3);
      border-top: 1px solid #d4d4d4;
      display: flex;
      justify-content: flex-end;
      gap: var(--sp2);
      background: var(--bg);
    }

    .tool-chip {
      background: var(--white);
      border: 1px solid #d4d4d4;
      padding: 6px 10px;
      font-family: var(--mono);
      font-size: 11px;
      color: var(--charcoal);
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: border-color var(--dur);
    }

    .tool-chip:hover {
      border-color: var(--char2);
    }

    .tool-chip-remove {
      cursor: pointer;
      color: var(--light);
      font-weight: bold;
      margin-left: 8px;
    }

    .tool-chip-remove:hover {
      color: var(--soft);
    }
  </style>
</head>

<body>

  <header class="topbar">
    <div class="brand">
      <div class="brand-mark">
        <span></span><span></span><span></span><span></span>
      </div>
      <span class="brand-name">Local Web LLM Â· Agent Interface</span>
    </div>
    <div class="topbar-center">
      <div class="status-dot" id="statusDot"></div>
      <span class="status-text" id="statusText">Offline</span>
    </div>
    <div class="topbar-right">
      <span class="live-badge">Speed: <span id="liveSpeed">â€”</span> tok/s</span>
      <span class="live-badge">Model: <span id="liveModel">â€”</span></span>
    </div>
  </header>

  <div class="shell">

    <!-- LEFT -->
    <aside class="panel-left">

      <div class="panel-section">
        <div class="section-label">Model</div>
        <select class="model-select" id="modelSelect">
          <option value="onnx-community/LFM2-1.2B-ONNX">LFM2-1.2B (base)</option>
          <option value="onnx-community/LFM2-1.2B-ONNX">LFM2-1.2B-Instruct</option>
          <option value="onnx-community/Qwen3-0.6B-ONNX">Qwen3-0.6B-ONNX</option>
        </select>
        <button class="load-btn" id="loadBtn" onclick="loadModel()">
          Load Model
          <svg viewBox="0 0 10 10" fill="none" stroke="currentColor" stroke-width="1.5" width="10" height="10">
            <path d="M5 1v6M2 5l3 3 3-3" />
          </svg>
        </button>
        <div class="progress-wrap hidden" id="progressWrap">
          <div class="progress-track">
            <div class="progress-fill" id="progressFill"></div>
          </div>
          <div class="progress-meta">
            <span class="progress-label" id="progressLabel">Initializing...</span>
            <span class="progress-pct" id="progressPct">0%</span>
          </div>
        </div>
      </div>

      <div class="panel-section">
        <div class="section-label">System Prompt</div>
        <textarea class="sys-prompt" id="sysPrompt"
          rows="4">You are a helpful AI assistant running locally in your browser. Be concise and precise. When the user's request can be answered using an available tool or function, you must use it.</textarea>
      </div>

      <div class="panel-section">
        <div class="section-label" style="display:flex; justify-content:space-between;">
          <span>Functions (Tools)</span>
          <span style="cursor:pointer; color:var(--orange); font-size:10px" onclick="openToolModal()">+ Add Tool</span>
        </div>
        <div id="toolsList" style="display:flex; flex-direction:column; gap:8px;">
          <span style="font-size:11px; color:var(--light)">No tools added.</span>
        </div>
      </div>

      <div class="panel-section">
        <div class="section-label">Parameters</div>
        <div class="slider-row">
          <div class="slider-label">
            <span class="slider-name">Max Tokens</span>
            <span class="slider-val" id="maxTokensVal">512</span>
          </div>
          <input type="range" id="maxTokens" min="64" max="2048" step="64" value="512"
            oninput="document.getElementById('maxTokensVal').textContent=this.value; updateSlider(this)">
        </div>
        <div class="slider-row">
          <div class="slider-label">
            <span class="slider-name">Temperature</span>
            <span class="slider-val" id="temperatureVal">0.05</span>
          </div>
          <input type="range" id="temperature" min="0" max="2" step="0.05" value="0.05"
            oninput="document.getElementById('temperatureVal').textContent=parseFloat(this.value).toFixed(2); updateSlider(this)">
        </div>
        <div class="slider-row">
          <div class="slider-label">
            <span class="slider-name">Top-P</span>
            <span class="slider-val" id="topPVal">0.90</span>
          </div>
          <input type="range" id="topP" min="0.1" max="1" step="0.05" value="0.9"
            oninput="document.getElementById('topPVal').textContent=parseFloat(this.value).toFixed(2); updateSlider(this)">
        </div>
        <div class="slider-row">
          <div class="slider-label">
            <span class="slider-name">Rep. Penalty</span>
            <span class="slider-val" id="repPenaltyVal">1.10</span>
          </div>
          <input type="range" id="repPenalty" min="1" max="2" step="0.05" value="1.1"
            oninput="document.getElementById('repPenaltyVal').textContent=parseFloat(this.value).toFixed(2); updateSlider(this)">
        </div>
      </div>

      <div class="panel-section">
        <div class="section-label">Architecture</div>
        <div class="spec-row"><span class="spec-key">Type</span><span class="spec-val hl">Web LLM</span></div>
        <div class="spec-row"><span class="spec-key">Params</span><span class="spec-val">Variable</span></div>
        <div class="spec-row"><span class="spec-key">Precision</span><span class="spec-val">q4</span></div>
        <div class="spec-row"><span class="spec-key">Backend</span><span class="spec-val">WebGPU â†’ WASM</span></div>
        <div class="spec-row"><span class="spec-key">Runtime</span><span class="spec-val">Transformers.js 3.7</span>
        </div>
      </div>

      <div class="panel-section">
        <button class="clear-btn" onclick="clearChat()">Clear Conversation</button>
      </div>

    </aside>

    <!-- CENTER -->
    <main class="panel-center">

      <div class="chat-header">
        <span class="chat-header-title">Inference Session</span>
        <span class="chat-header-meta" id="sessionMeta">SES Â· â€”</span>
      </div>

      <div class="init-overlay" id="initOverlay">
        <div class="init-glyph">
          <div class="init-cell"></div>
          <div class="init-cell"></div>
          <div class="init-cell"></div>
          <div class="init-cell"></div>
          <div class="init-cell"></div>
          <div class="init-cell"></div>
          <div class="init-cell"></div>
          <div class="init-cell"></div>
          <div class="init-cell"></div>
          <div class="init-cell"></div>
          <div class="init-cell"></div>
          <div class="init-cell"></div>
        </div>
        <div class="init-title">Select a model<br>and press Load.</div>
        <div class="init-sub">
          The models run entirely in your browser<br>
          via WebGPU or WebAssembly.<br>
          No data leaves your device.
        </div>
      </div>

      <div class="messages hidden" id="messages"></div>

      <div class="token-bar hidden" id="tokenBar">
        <div class="tbar-item">
          <span class="tbar-key">Speed</span>
          <span class="tbar-val active" id="statSpeed">â€”</span>
          <span class="tbar-key">tok/s</span>
        </div>
        <div class="tbar-sep"></div>
        <div class="tbar-item">
          <span class="tbar-key">Total tokens</span>
          <span class="tbar-val" id="statTokens">0</span>
        </div>
        <div class="tbar-sep"></div>
        <div class="tbar-item">
          <span class="tbar-key">Messages</span>
          <span class="tbar-val" id="statMessages">0</span>
        </div>
        <div class="tbar-sep"></div>
        <div class="tbar-item">
          <span class="tbar-key">Ctx</span>
          <span class="tbar-val" id="ctxTokens">0</span>
          <span class="tbar-key">~tok</span>
        </div>
      </div>

      <div class="input-area hidden" id="inputArea">
        <div class="input-row">
          <textarea class="user-input" id="userInput" placeholder="Send a message..." rows="1"
            onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
          <button class="send-btn" id="sendBtn" onclick="sendMessage()">
            Send
            <svg viewBox="0 0 10 10" fill="none" stroke="currentColor" stroke-width="1.5" width="10" height="10">
              <path d="M1 5h8M5 1l4 4-4 4" />
            </svg>
          </button>
        </div>
        <div class="input-hint">â†µ Send Â· Shift+â†µ New line</div>
      </div>

    </main>

    <!-- RIGHT -->
    <aside class="panel-right">

      <div class="metric-block">
        <div class="section-label" style="margin-bottom:0">Performance</div>
        <div class="metric-row">
          <div class="metric-label">
            <span class="metric-name">Tokens / sec</span>
            <span class="metric-value active" id="mTps">â€”</span>
          </div>
          <div class="bar-track">
            <div class="bar-fill hl" id="bTps" style="width:0%"></div>
          </div>
        </div>
        <div class="metric-row">
          <div class="metric-label">
            <span class="metric-name">Context est.</span>
            <span class="metric-value" id="mCtx">0</span>
          </div>
          <div class="bar-track">
            <div class="bar-fill" id="bCtx" style="width:0%"></div>
          </div>
        </div>
        <div class="metric-row">
          <div class="metric-label">
            <span class="metric-name">Total tokens</span>
            <span class="metric-value" id="mTotal">0</span>
          </div>
          <div class="bar-track">
            <div class="bar-fill" id="bTotal" style="width:0%"></div>
          </div>
        </div>
      </div>

      <div class="metric-block" style="border-bottom:none; padding-bottom:var(--sp2)">
        <div class="section-label" style="margin-bottom:0">Event Log</div>
      </div>
      <div class="log-wrap">
        <div class="log-stream" id="logStream"></div>
      </div>

    </aside>

  </div>

  <footer class="footer">
    <div class="footer-headline">
      Complexity can look impressive, <br> but <em> simplicity</em> is often the real genius
    </div>
    <div class="footer-viz">
      <span class="footer-viz-label">Session throughput</span>
      <div class="viz-bars" id="vizBars"></div>
    </div>
  </footer>

  <div id="toolModal" class="modal-overlay hidden">
    <div class="modal">
      <div class="modal-header" style="display:flex; justify-content:space-between; align-items:center;">
        <span class="modal-title">Create Function (Tool)</span>
        <div style="display:flex; gap:8px; align-items:center;">
          <span
            style="font-size:11px; color:var(--light); font-family:var(--mono); text-transform:uppercase;">Examples:</span>
          <button class="clear-btn"
            style="width:auto; padding:4px 8px; min-height:0; border-radius:12px; font-size:10px"
            onclick="loadToolExample('weather')">Weather</button>
          <button class="clear-btn"
            style="width:auto; padding:4px 8px; min-height:0; border-radius:12px; font-size:10px"
            onclick="loadToolExample('stock')">Stocks</button>
          <button class="clear-btn"
            style="width:auto; padding:4px 8px; min-height:0; border-radius:12px; font-size:10px"
            onclick="loadToolExample('calendar')">Calendar</button>
          <button class="clear-btn"
            style="width:auto; padding:4px 8px; min-height:0; border-radius:12px; font-size:10px"
            onclick="loadToolExample('ip')">Get IP</button>
          <button class="clear-btn"
            style="width:auto; padding:4px 8px; min-height:0; border-radius:12px; font-size:10px"
            onclick="loadToolExample('time')">Time</button>
          <button class="clear-btn"
            style="width:auto; padding:4px 8px; min-height:0; border-radius:12px; font-size:10px"
            onclick="loadToolExample('date')">Date</button>
        </div>
      </div>
      <div class="modal-body">
        <div class="input-lbl">JSON Schema</div>
        <textarea id="toolSchemaInput" class="sys-prompt" rows="8"
          style="font-size:11px; white-space:pre; overflow-x:auto;"></textarea>

        <div class="input-lbl" style="margin-top:var(--sp2); display:flex; justify-content:space-between;">
          <span>Implementation (JavaScript)</span>
          <span style="cursor:pointer; color:var(--orange); font-size:10px" onclick="formatToolCode()">Format</span>
        </div>
        <textarea id="toolCodeInput" class="sys-prompt" rows="6"
          style="font-size:11px; white-space:pre; overflow-x:auto;"></textarea>
      </div>
      <div class="modal-footer">
        <button class="clear-btn" style="width:auto; padding:6px 16px; min-height:0"
          onclick="closeToolModal()">Cancel</button>
        <button class="send-btn" style="height:auto; padding:6px 16px; margin:0; line-height:1"
          onclick="submitTool()">Save Tool</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { pipeline, TextStreamer, env } from 'https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.7.0/dist/transformers.min.js';

    // Make available globally for onclick handlers
    window._tf = { pipeline, TextStreamer, env };

    // â”€â”€ State
    let generator = null;
    let conversationHistory = [];
    let isGenerating = false;
    let totalTokensGenerated = 0;
    let genStartTime = null;
    let currentTokenCount = 0;
    let throughputHistory = Array(20).fill(0);
    let currentEditingIndex = -1;
    const sessionStart = Date.now();

    // â”€â”€ Init sliders
    document.querySelectorAll('input[type=range]').forEach(el => {
      const min = +el.min, max = +el.max, val = +el.value;
      el.style.setProperty('--fill', ((val - min) / (max - min) * 100) + '%');
    });
    window.updateSlider = el => {
      const min = +el.min, max = +el.max, val = +el.value;
      el.style.setProperty('--fill', ((val - min) / (max - min) * 100) + '%');
    };

    // â”€â”€ Viz bars
    function renderVizBars() {
      const el = document.getElementById('vizBars');
      el.innerHTML = '';
      const max = Math.max(...throughputHistory, 1);
      throughputHistory.forEach(val => {
        const b = document.createElement('div');
        b.className = 'viz-bar' + (val === Math.max(...throughputHistory) && val > 0 ? ' hl' : '');
        b.style.height = Math.max(2, (val / max) * 22) + 'px';
        el.appendChild(b);
      });
    }
    renderVizBars();
    setInterval(renderVizBars, 1200);

    // â”€â”€ Session timer
    setInterval(() => {
      const s = Math.floor((Date.now() - sessionStart) / 1000);
      const m = String(Math.floor(s / 60)).padStart(2, '0');
      document.getElementById('sessionMeta').textContent = `SES Â· ${m}:${String(s % 60).padStart(2, '0')}`;
    }, 1000);

    // â”€â”€ Log
    function log(text, type = '') {
      const ls = document.getElementById('logStream');
      const ts = new Date().toISOString().slice(11, 19);
      const el = document.createElement('div');
      el.className = 'log-entry' + (type ? ' ' + type : '');
      el.innerHTML = `<span class="ts">${ts}</span>${text}`;
      ls.appendChild(el);
      ls.scrollTop = ls.scrollHeight;
      if (ls.children.length > 120) ls.firstChild.remove();
    }

    // â”€â”€ LOAD MODEL
    window.loadModel = async function () {
      const { pipeline, TextStreamer, env } = window._tf;
      const btn = document.getElementById('loadBtn');
      const wrap = document.getElementById('progressWrap');
      const fill = document.getElementById('progressFill');
      const label = document.getElementById('progressLabel');
      const pct = document.getElementById('progressPct');
      const modelId = document.getElementById('modelSelect').value;

      const fileProgress = new Map();

      btn.disabled = true;
      btn.innerHTML = `LOADING... <svg viewBox="0 0 10 10" fill="none" stroke="currentColor" stroke-width="1.5" width="10" height="10"><path d="M5 1v6M2 5l3 3 3-3"/></svg>`;
      wrap.classList.remove('hidden');
      document.getElementById('liveModel').textContent = modelId.split('/')[1];
      log('Initializing Â· ' + modelId);

      const onProgress = (progress) => {
        if (progress.status === 'downloading' || progress.status === 'progress') {
          fileProgress.set(progress.file, progress.progress || 0);

          // Calculate average progress of all tracked files
          let total = 0;
          for (const p of fileProgress.values()) {
            total += p;
          }
          const avg = Math.round(total / fileProgress.size);

          fill.style.width = avg + '%';
          pct.textContent = avg + '%';

          if (progress.file) {
            label.textContent = `Downloading ${progress.file.split('/').pop()}`;
          }
          if (avg % 10 === 0 && avg > 0) log(`Downloading Â· ${avg}%`);
        } else if (progress.status === 'initiate') {
          label.textContent = 'Initializing...';
        } else if (progress.status === 'loading') {
          fill.style.width = '95%';
          label.textContent = 'Loading model into runtime...';
          pct.textContent = '95%';
          log('Loading runtime...');
        } else if (progress.status === 'ready') {
          fill.style.width = '100%';
          pct.textContent = '100%';
          label.textContent = 'Ready';
        }
      };

      try {
        log('Trying WebGPU backend...');
        label.textContent = 'Trying WebGPU...';

        generator = await pipeline('text-generation', modelId, {
          dtype: 'q4f16',
          device: 'webgpu',
          progress_callback: onProgress
        }).catch(async gpuErr => {
          // log('WebGPU failed: ' + gpuErr.message.slice(0,60), 'warn');
          log('Falling back to WASM...', 'warn');
          label.textContent = 'WebGPU unavailable â€” switching to WASM...';
          fill.style.width = '0%';
          pct.textContent = '0%';
          return await pipeline('text-generation', modelId, {
            dtype: 'q4f16',
            device: 'wasm',
            progress_callback: onProgress
          });
        });

        // SUCCESS
        fill.style.width = '100%';
        pct.textContent = '100%';
        label.textContent = 'Ready';
        log('Model loaded. Inference ready.', 'ok');

        btn.disabled = false;
        btn.innerHTML = `Load Model <svg viewBox="0 0 10 10" fill="none" stroke="currentColor" stroke-width="1.5" width="10" height="10"><path d="M5 1v6M2 5l3 3 3-3"/></svg>`;

        document.getElementById('statusDot').classList.add('active');
        document.getElementById('statusText').textContent = 'ONLINE';

        document.getElementById('initOverlay').classList.add('hidden');
        document.getElementById('messages').classList.remove('hidden');
        document.getElementById('inputArea').classList.remove('hidden');
        document.getElementById('tokenBar').classList.remove('hidden');
        document.getElementById('userInput').focus();

      } catch (err) {
        log('FATAL: ' + err.message, 'warn');
        label.textContent = 'Error: ' + err.message;
        fill.style.background = 'rgba(220,38,38,0.7)';
        btn.disabled = false;
        btn.innerHTML = `RETRY <svg viewBox="0 0 10 10" fill="none" stroke="currentColor" stroke-width="1.5" width="10" height="10"><path d="M5 1v6M2 5l3 3 3-3"/></svg>`;
      }
    };

    // â”€â”€ SEND MESSAGE
    window.sendMessage = async function (isFollowUp = false) {
      if (!generator || isGenerating) return;

      const sysPrompt = document.getElementById('sysPrompt').value.trim();
      const msgContainer = document.getElementById('messages');

      if (!isFollowUp) {
        const input = document.getElementById('userInput');
        const text = input.value.trim();
        if (!text) return;
        input.value = '';
        autoResize(input);
        conversationHistory.push({ role: 'user', content: text });
        appendMessage('user', text);
        msgContainer.scrollTop = msgContainer.scrollHeight;
      }

      isGenerating = true;
      document.getElementById('sendBtn').disabled = true;

      // Build system prompt with tool definitions injected
      let fullSysPrompt = sysPrompt;
      const tools = window.registeredTools.map(t => t.schema);
      if (tools.length > 0) {
        const toolDefs = tools.map(t => JSON.stringify(t, null, 2)).join(',\n');

        // Build a concrete example using the first tool
        const firstFn = tools[0].function;
        const exampleArgs = {};
        if (firstFn.parameters && firstFn.parameters.properties) {
          for (const [key, val] of Object.entries(firstFn.parameters.properties)) {
            exampleArgs[key] = val.type === 'number' ? 0 : val.type === 'boolean' ? true : '...';
          }
        }
        const exampleCall = JSON.stringify({ name: firstFn.name, arguments: exampleArgs });

        fullSysPrompt += `\n\nYou have access to the following tools:\n${toolDefs}\n\nWhen the user's request requires using a tool, respond ONLY with a JSON object (no explanation, no markdown) like this:\n${exampleCall}\n\nReplace the argument values with the actual values from the user's request. Only call tools that are listed above. After receiving the tool result, interpret it and respond to the user in natural language.`;
      }

      const msgArray = fullSysPrompt
        ? [{ role: 'system', content: fullSysPrompt }, ...conversationHistory]
        : [...conversationHistory];

      const aiMsgEl = appendMessage('assistant', '');
      const contentEl = aiMsgEl.querySelector('.msg-content');
      const cursor = document.createElement('span');
      cursor.className = 'typing-cursor';
      contentEl.appendChild(cursor);

      let outputText = '';
      let rawOutputText = ''; // includes special tokens for tool call parsing
      currentTokenCount = 0;
      genStartTime = Date.now();
      log(`Generating Â· max_tokens=${document.getElementById('maxTokens').value} Â· temp=${document.getElementById('temperature').value}`);

      const streamer = new window._tf.TextStreamer(generator.tokenizer, {
        skip_prompt: true,
        skip_special_tokens: false,
        callback_function: (token) => {
          rawOutputText += token;
          // Strip common special tokens for display
          const displayToken = token
            .replace(/<\|im_end\|>/g, '')
            .replace(/<\|im_start\|>/g, '')
            .replace(/<\|endoftext\|>/g, '')
            .replace(/<\|tool_call_start\|>/g, '')
            .replace(/<\|tool_call_end\|>/g, '');
          outputText += displayToken;

          // Check if we're inside a tool_call block â€” don't render it visually
          const inQwenToolCall = rawOutputText.includes('<tool_call>') && !rawOutputText.includes('</tool_call>');
          const inLfmToolCall = rawOutputText.includes('<|tool_call_start|>') && !rawOutputText.includes('<|tool_call_end|>');
          const inToolCall = inQwenToolCall || inLfmToolCall;
          if (!inToolCall) {
            // Clean display: remove tool_call blocks from visible text
            const cleanDisplay = outputText
              .replace(/<tool_call>[\s\S]*?<\/tool_call>/g, '[Calling tool...]')
              .replace(/\[[^\]]*\([^)]*\)\]/g, '[Calling tool...]')  // Pythonic calls like [fn(args)]
              .trim();
            if (cleanDisplay) {
              contentEl.innerHTML = marked.parse(cleanDisplay);
            }
          } else {
            contentEl.innerHTML = '<span style="color:var(--orange)">âš¡ Preparing tool call...</span>';
          }
          const cursorContainer = contentEl.lastElementChild && contentEl.lastElementChild.tagName !== 'PRE' && contentEl.lastElementChild.tagName !== 'UL' && contentEl.lastElementChild.tagName !== 'OL' ? contentEl.lastElementChild : contentEl;
          cursorContainer.appendChild(cursor);
          currentTokenCount++;
          totalTokensGenerated++;

          const elapsed = (Date.now() - genStartTime) / 1000;
          if (elapsed > 0) {
            const tps = (currentTokenCount / elapsed).toFixed(1);
            document.getElementById('liveSpeed').textContent = tps;
            document.getElementById('statSpeed').textContent = tps;
            document.getElementById('mTps').textContent = tps;
            document.getElementById('bTps').style.width = Math.min(100, (parseFloat(tps) / 40) * 100) + '%';
            throughputHistory.push(parseFloat(tps));
            if (throughputHistory.length > 20) throughputHistory.shift();
          }

          document.getElementById('statTokens').textContent = totalTokensGenerated;
          document.getElementById('mTotal').textContent = totalTokensGenerated;
          document.getElementById('bTotal').style.width = Math.min(100, (totalTokensGenerated / 3000) * 100) + '%';
          msgContainer.scrollTop = msgContainer.scrollHeight;
        }
      });

      try {
        const maxTokens = parseInt(document.getElementById('maxTokens').value);
        const temp = parseFloat(document.getElementById('temperature').value);
        const topP = parseFloat(document.getElementById('topP').value);
        const repPenalty = parseFloat(document.getElementById('repPenalty').value);

        console.log('Sending to LLM:', msgArray);
        const result = await generator(msgArray, {
          max_new_tokens: maxTokens,
          tools: tools.length > 0 ? tools : undefined,
          do_sample: temp > 0,
          temperature: temp > 0 ? temp : undefined,
          top_p: topP,
          repetition_penalty: repPenalty,
          return_full_text: false,
          streamer
        });

        cursor.remove();

        // --- Parse tool calls from multiple sources ---
        let toolCalls = [];

        // 1. Check pipeline structured result
        let assistantMessage = null;
        if (result && result[0] && Array.isArray(result[0].generated_text)) {
          assistantMessage = result[0].generated_text[result[0].generated_text.length - 1];
          if (assistantMessage.tool_calls && assistantMessage.tool_calls.length > 0) {
            toolCalls = assistantMessage.tool_calls;
            log('Tool calls found via pipeline result', 'ok');
          }
        }

        // 2. Parse raw text for <tool_call> blocks (Qwen/Hermes style)
        if (toolCalls.length === 0) {
          toolCalls = parseToolCalls(rawOutputText);
          if (toolCalls.length > 0) {
            log(`Parsed ${toolCalls.length} tool call(s) from raw output`, 'ok');
          }
        }

        // Build the clean content (without tool call markup)
        const cleanContent = outputText
          .replace(/<tool_call>[\s\S]*?<\/tool_call>/g, '')
          .replace(/\[[^\]]*\([^)]*\)\]/g, '')  // Pythonic calls
          .replace(/\[Calling tool\.\.\.\]/g, '')
          .trim();

        if (toolCalls.length > 0) {
          // We have tool calls to execute
          const histMsg = assistantMessage && assistantMessage.tool_calls
            ? assistantMessage
            : { role: 'assistant', content: cleanContent || null, tool_calls: toolCalls };
          conversationHistory.push(histMsg);

          contentEl.innerHTML = '<span style="color:var(--orange)">âš¡ Executing tools...</span>';

          for (let tc of toolCalls) {
            const fnName = tc.function.name;
            log('Tool called: ' + fnName);
            const toolObj = window.registeredTools.find(t => t.schema.function.name === fnName);

            let toolResult = '';
            if (toolObj) {
              try {
                const args = typeof tc.function.arguments === 'string' ? JSON.parse(tc.function.arguments) : tc.function.arguments;
                log('Tool args: ' + JSON.stringify(args));
                const res = await toolObj.fn(args);
                toolResult = typeof res === 'string' ? res : JSON.stringify(res);
              } catch (e) {
                toolResult = 'Error executing function: ' + e.message;
              }
            } else {
              toolResult = `Tool "${fnName}" not found locally.`;
            }

            conversationHistory.push({ role: 'tool', name: fnName, content: toolResult });
            appendMessage('tool', `ðŸ”§ **${fnName}** returned:\n\`\`\`json\n${toolResult}\n\`\`\``);
          }

          // Update stats
          const userCount = conversationHistory.filter(m => m.role === 'user').length;
          document.getElementById('statMessages').textContent = userCount;
          const ctxEst = conversationHistory.reduce((a, m) => a + Math.round((m.content || '').length / 4), 0);
          document.getElementById('ctxTokens').textContent = ctxEst;
          document.getElementById('mCtx').textContent = ctxEst;
          document.getElementById('bCtx').style.width = Math.min(100, (ctxEst / 8000) * 100) + '%';

          const finalTps = (currentTokenCount / ((Date.now() - genStartTime) / 1000)).toFixed(1);
          log(`Done Â· ${currentTokenCount} tokens Â· ${finalTps} tok/s`, 'ok');

          isGenerating = false;
          log('Feeding tool results back into generator...');
          return await window.sendMessage(true);

        } else {
          // Normal text response, no tool calls
          if (cleanContent) {
            contentEl.innerHTML = marked.parse(cleanContent);
          }
          conversationHistory.push({ role: 'assistant', content: cleanContent || outputText });

          const userCount = conversationHistory.filter(m => m.role === 'user').length;
          document.getElementById('statMessages').textContent = userCount;

          const ctxEst = conversationHistory.reduce((a, m) => a + Math.round((m.content || '').length / 4), 0);
          document.getElementById('ctxTokens').textContent = ctxEst;
          document.getElementById('mCtx').textContent = ctxEst;
          document.getElementById('bCtx').style.width = Math.min(100, (ctxEst / 8000) * 100) + '%';

          const finalTps = (currentTokenCount / ((Date.now() - genStartTime) / 1000)).toFixed(1);
          log(`Done Â· ${currentTokenCount} tokens Â· ${finalTps} tok/s`, 'ok');
        }

      } catch (err) {
        cursor.remove();
        contentEl.textContent += '\n[Error: ' + err.message + ']';
        contentEl.style.color = 'var(--soft)';
        log('Generation error: ' + err.message, 'warn');
      }

      isGenerating = false;
      document.getElementById('sendBtn').disabled = false;
      document.getElementById('userInput').focus();
    };

    // â”€â”€ APPEND MESSAGE
    function appendMessage(role, content) {
      const container = document.getElementById('messages');
      const div = document.createElement('div');
      div.className = 'message ' + role;
      const now = new Date().toTimeString().slice(0, 8);

      let avatarStr = 'AI';
      let nameStr = 'ASSISTANT';
      if (role === 'user') { avatarStr = 'USR'; nameStr = 'OPERATOR'; }
      else if (role === 'tool') { avatarStr = 'SYS'; nameStr = 'TOOL EXECUTION'; }

      div.innerHTML = `
      <div class="msg-avatar">${avatarStr}</div>
      <div class="msg-body">
        <div class="msg-header">
          <span class="msg-name">${nameStr}</span>
          <span class="msg-time">${now}</span>
        </div>
        <div class="msg-content"></div>
      </div>
    `;

      const contentDiv = div.querySelector('.msg-content');
      if (role === 'user') {
        contentDiv.textContent = content;
      } else {
        contentDiv.innerHTML = content ? marked.parse(content) : '';
      }

      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
      return div;
    }

    // â”€â”€ UTILITIES
    window.clearChat = function () {
      conversationHistory = [];
      document.getElementById('messages').innerHTML = '';
      ['statMessages', 'ctxTokens', 'mCtx'].forEach(id => document.getElementById(id).textContent = '0');
      document.getElementById('bCtx').style.width = '0%';
      log('Conversation cleared.', 'ok');
    };
    window.handleKey = function (e) {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); window.sendMessage(); }
    };
    window.autoResize = function (el) {
      el.style.height = 'auto';
      el.style.height = Math.min(el.scrollHeight, 140) + 'px';
    };

    // â”€â”€ PARSE TOOL CALLS from raw text
    // Supports:
    //   Qwen-style:  <tool_call>{"name":..., "arguments":...}</tool_call>
    //   LFM2.5-style: <|tool_call_start|>[fn_name(arg="val")]<|tool_call_end|>  (Pythonic)
    //   LFM2.5 JSON: <|tool_call_start|>{"name":..., "arguments":...}<|tool_call_end|>
    function parseToolCalls(rawText) {
      const calls = [];
      let match;

      // Pattern 1: Qwen â€” <tool_call>{ JSON }</tool_call>
      const qwenRegex = /<tool_call>\s*([\s\S]*?)\s*<\/tool_call>/g;
      while ((match = qwenRegex.exec(rawText)) !== null) {
        try {
          const parsed = JSON.parse(match[1].trim());
          if (parsed.name) {
            calls.push({
              function: {
                name: parsed.name,
                arguments: parsed.arguments || {}
              }
            });
          }
        } catch (e) {
          log('Failed to parse Qwen tool_call JSON: ' + e.message, 'warn');
        }
      }

      // Pattern 2: LFM2.5 â€” <|tool_call_start|>...<|tool_call_end|>
      if (calls.length === 0) {
        const lfmRegex = /<\|tool_call_start\|>\s*([\s\S]*?)\s*<\|tool_call_end\|>/g;
        while ((match = lfmRegex.exec(rawText)) !== null) {
          const block = match[1].trim();

          // Try JSON first
          try {
            const parsed = JSON.parse(block);
            if (parsed.name) {
              calls.push({
                function: {
                  name: parsed.name,
                  arguments: parsed.arguments || parsed.parameters || {}
                }
              });
              continue;
            }
          } catch (e) { /* not JSON, try Pythonic */ }

          // Parse Pythonic: [func_name(key="value", key2=123)] or func_name(key="value")
          const pyMatches = block.matchAll(/([a-zA-Z_][a-zA-Z0-9_]*)\(([^)]*)\)/g);
          for (const pm of pyMatches) {
            const fnName = pm[1];
            const argsStr = pm[2].trim();
            const args = {};
            if (argsStr) {
              // Parse key=value pairs, handling quoted strings and numbers
              const argRegex = /([a-zA-Z_][a-zA-Z0-9_]*)\s*=\s*(?:"([^"]*)"|'([^']*)'|([^,\s)]+))/g;
              let argMatch;
              while ((argMatch = argRegex.exec(argsStr)) !== null) {
                const key = argMatch[1];
                const val = argMatch[2] ?? argMatch[3] ?? argMatch[4];
                // Try parsing as number/bool
                if (val === 'true') args[key] = true;
                else if (val === 'false') args[key] = false;
                else if (val === 'None' || val === 'null') args[key] = null;
                else if (!isNaN(Number(val)) && val !== '') args[key] = Number(val);
                else args[key] = val;
              }
            }
            calls.push({ function: { name: fnName, arguments: args } });
          }
        }
      }

      // Pattern 3: code block fallback
      if (calls.length === 0) {
        const codeBlockRegex = /```(?:json)?\s*\n?\s*(\{[\s\S]*?"name"[\s\S]*?\})\s*\n?\s*```/g;
        while ((match = codeBlockRegex.exec(rawText)) !== null) {
          try {
            const parsed = JSON.parse(match[1].trim());
            if (parsed.name && (parsed.arguments || parsed.parameters)) {
              calls.push({
                function: {
                  name: parsed.name,
                  arguments: parsed.arguments || parsed.parameters || {}
                }
              });
            }
          } catch (e) { /* ignore */ }
        }
      }

      // Pattern 4: Raw JSON object in output (no wrappers) â€” for models instructed via system prompt
      if (calls.length === 0) {
        // Try to find any JSON object with "name" in the text
        const jsonRegex = /\{[^{}]*"name"\s*:\s*"([^"]+)"[^{}]*"arguments"\s*:\s*(\{[^{}]*\})[^{}]*\}/g;
        while ((match = jsonRegex.exec(rawText)) !== null) {
          try {
            const parsed = JSON.parse(match[0]);
            if (parsed.name) {
              // Validate it's actually one of our registered tools
              const isRegistered = window.registeredTools.some(t => t.schema.function.name === parsed.name);
              if (isRegistered) {
                calls.push({
                  function: {
                    name: parsed.name,
                    arguments: parsed.arguments || parsed.parameters || {}
                  }
                });
              }
            }
          } catch (e) { /* ignore */ }
        }
      }

      return calls;
    }

    // â”€â”€ TOOLS MANAGEMENT
    window.registeredTools = [];

    window.toolExamples = {
      weather: {
        schema: {
          type: "function",
          function: {
            name: "get_weather",
            description: "Get current weather updates for a given location",
            parameters: {
              type: "object",
              properties: { location: { type: "string", description: "City name, e.g. Paris" } },
              required: ["location"]
            }
          }
        },
        code: `async ({ location }) => {\n  // Mock API call\n  const temps = { "Paris": "18Â°C", "New York": "24Â°C", "Tokyo": "22Â°C", "London": "15Â°C" };\n  return { location, temperature: temps[location] || "20Â°C", condition: "Sunny" };\n}`
      },
      stock: {
        schema: {
          type: "function",
          function: {
            name: "get_stock_price",
            description: "Get the current stock price for a given ticker symbol",
            parameters: {
              type: "object",
              properties: { ticker: { type: "string", description: "Stock ticker, e.g. AAPL" } },
              required: ["ticker"]
            }
          }
        },
        code: `async ({ ticker }) => {\n  // Mock API call\n  const prices = { "AAPL": "$150.00", "GOOGL": "$2800.00", "MSFT": "$300.00" };\n  return { ticker, price: prices[ticker.toUpperCase()] || "$100.00", currency: "USD" };\n}`
      },
      calendar: {
        schema: {
          type: "function",
          function: {
            name: "create_calendar_event",
            description: "Create a new event in the user's calendar",
            parameters: {
              type: "object",
              properties: {
                title: { type: "string", description: "Event title" },
                date: { type: "string", description: "Date of the event (YYYY-MM-DD)" },
                time: { type: "string", description: "Time of the event (HH:MM)" }
              },
              required: ["title", "date", "time"]
            }
          }
        },
        code: `async ({ title, date, time }) => {\n  // Mock DB interaction\n  return { success: true, event_id: "evt_" + Math.random().toString(36).substr(2, 6), title, scheduled_for: \`\${date} at \${time}\` };\n}`
      },
      ip: {
        schema: {
          type: "function",
          function: {
            name: "get_ip_address",
            description: "Get the current public IP address of the user",
            parameters: {
              type: "object",
              properties: {},
              required: []
            }
          }
        },
        code: `async () => {\n  try {\n    const res = await fetch("https://api.ipify.org/?format=json");\n    const data = await res.json();\n    return data;\n  } catch (error) {\n    return { error: error.message };\n  }\n}`
      },
      time: {
        schema: {
          type: "function",
          function: {
            name: "get_current_time",
            description: "Get the current time",
            parameters: {
              type: "object",
              properties: {},
              required: []
            }
          }
        },
        code: `async () => {\n  const now = new Date();\n  return { time: now.toLocaleTimeString(), iso: now.toISOString() };\n}`
      },
      date: {
        schema: {
          type: "function",
          function: {
            name: "get_current_date",
            description: "Get the current date",
            parameters: {
              type: "object",
              properties: {},
              required: []
            }
          }
        },
        code: `async () => {\n  const now = new Date();\n  return { date: now.toLocaleDateString(), iso: now.toISOString() };\n}`
      }
    };

    window.loadToolExample = (key) => {
      const ex = window.toolExamples[key];
      if (ex) {
        document.getElementById('toolSchemaInput').value = JSON.stringify(ex.schema, null, 2);
        document.getElementById('toolCodeInput').value = ex.code;
      }
    };

    window.openToolModal = (index = -1) => {
      const modalTitle = document.querySelector('.modal-title');
      const schemaInput = document.getElementById('toolSchemaInput');
      const codeInput = document.getElementById('toolCodeInput');

      currentEditingIndex = index;

      if (index !== -1) {
        const tool = window.registeredTools[index];
        schemaInput.value = JSON.stringify(tool.schema, null, 2);
        codeInput.value = tool.codeRaw;
        modalTitle.textContent = "Edit Function (Tool)";
      } else {
        if (!schemaInput.value.trim()) {
          window.loadToolExample('weather');
        }
        modalTitle.textContent = "Create Function (Tool)";
      }
      document.getElementById('toolModal').classList.remove('hidden');
    };
    window.closeToolModal = () => {
      document.getElementById('toolModal').classList.add('hidden');
      currentEditingIndex = -1;
    };

    window.formatToolCode = () => {
      const schemaEl = document.getElementById('toolSchemaInput');
      try {
        if (schemaEl.value.trim()) schemaEl.value = JSON.stringify(JSON.parse(schemaEl.value.trim()), null, 2);
      } catch (e) { log('Schema format failed', 'warn'); }
    };

    window.submitTool = () => {
      try {
        const schemaRaw = document.getElementById('toolSchemaInput').value.trim();
        const codeRaw = document.getElementById('toolCodeInput').value.trim();
        if (!schemaRaw || !codeRaw) throw new Error("Both schema and code are required.");

        const schema = JSON.parse(schemaRaw);
        if (!schema.type || !schema.function || !schema.function.name) throw new Error("Invalid schema structure.");

        const fn = eval('(' + codeRaw + ')');
        if (typeof fn !== 'function') throw new Error("Implementation is not a valid function.");

        if (currentEditingIndex !== -1) {
          window.registeredTools[currentEditingIndex] = { schema, codeRaw, fn };
          log(`Updated tool: ${schema.function.name}.`, 'ok');
        } else {
          window.registeredTools.push({ schema, codeRaw, fn });
          log(`Added tool: ${schema.function.name}.`, 'ok');
        }

        renderTools();
        closeToolModal();
      } catch (e) {
        alert("Configuration Error: " + e.message);
      }
    };

    window.removeTool = (index) => {
      const t = window.registeredTools.splice(index, 1)[0];
      renderTools();
      log(`Removed tool: ${t.schema.function.name}`, 'warn');
    };

    function renderTools() {
      const list = document.getElementById('toolsList');
      if (window.registeredTools.length === 0) {
        list.innerHTML = '<span style="font-size:11px; color:var(--light)">No tools added.</span>';
        return;
      }
      list.innerHTML = '';
      window.registeredTools.forEach((t, i) => {
        const div = document.createElement('div');
        div.className = 'tool-chip';
        div.onclick = () => window.openToolModal(i);
        div.innerHTML = `<span>âš¡ ${t.schema.function.name}</span><span class="tool-chip-remove" onclick="event.stopPropagation(); removeTool(${i})">âœ•</span>`;
        list.appendChild(div);
      });
    }

    log('Interface ready. Select model and press Load.', 'ok');
  </script>
</body>

</html>